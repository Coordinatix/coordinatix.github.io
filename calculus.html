<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Calculus Solver</title>
  <!-- MathQuill CSS (UI for math input) -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/mathquill@0.10.1/build/mathquill.css">
  <style>
    :root{--bg1:#eef2f3;--bg2:#8e9eab}
    body {
      font-family: 'Segoe UI', Roboto, Arial, sans-serif;
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      margin: 0;
      background: linear-gradient(90deg, var(--bg1), var(--bg2));
      padding: 20px;
    }
    .container{
      background: white;
      width: 720px;
      max-width: 100%;
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.12);
      display: grid;
      grid-template-columns: 1fr 360px;
      gap: 18px;
      align-items: start;
    }
    h1{margin:0 0 10px 0;font-size:20px}
    .left{padding-right:8px}
    #inputField{min-height:44px;border:1px solid #ddd;border-radius:8px;padding:10px}
    #solveBtn{display:inline-block;padding:10px 14px;border-radius:8px;border:none;background:#0078d7;color:#fff;cursor:pointer}
    #examples button{margin:6px 6px 0 0;padding:6px 8px;border-radius:8px;border:1px solid #ccc;background:#fafafa;cursor:pointer}
    #output{margin-top:12px;padding:10px;border-radius:8px;background:#f6f8fa;border:1px solid #eee;min-height:44px}
    .right{font-size:14px}
    .tests{margin-top:12px}
    .ok{color:green}
    .bad{color:red}
    .small{font-size:13px;color:#555}
    pre{white-space:pre-wrap}
  </style>
</head>
<body>
  <div class="container">
    <div class="left">
      <h1> Calculus Solver</h1>
      <p class="small">Type an integral using the MathQuill math box. Examples are provided on the right — click one to load it. Supports indefinite and definite integrals. This page uses <strong>MathQuill</strong> for input and <strong>Algebrite</strong> for symbolic integration (and math.js as a numeric helper).</p>

      <div id="inputField"></div>
      <div style="margin-top:10px">
        <button id="solveBtn">Solve</button>
        <button id="clearBtn" style="margin-left:8px">Clear</button>
      </div>

      <div id="output" aria-live="polite"></div>

      <div class="tests">
        <h3 style="margin:10px 0 6px 0">Quick internal tests</h3>
        <div id="testResults" class="small"></div>
        <button id="runTests" style="margin-top:8px;padding:8px 10px;border-radius:8px;border:1px solid #ccc;background:#fff;cursor:pointer">Run tests</button>
      </div>

    </div>

    <div class="right">
      <h3 style="margin-top:0">Examples</h3>
      <div id="examples">
        <button data-l="\\int x^2 \\, d x">∫ x² dx</button>
        <button data-l="\\int_{0}^{1} x^2 \\, d x">∫₀¹ x² dx</button>
        <button data-l="\\int \\sin(x) \\, d x">∫ sin(x) dx</button>
        <button data-l="\\int_{0}^{\\pi} \\sin(x) \\, d x">∫₀^{π} sin(x) dx</button>
        <button data-l="\\int e^{x} \\, d x">∫ eˣ dx</button>
      </div>

      <h3 style="margin-top:14px">Notes / Debug</h3>
      <div class="small">This fixed version addresses the errors you saw:
        <ul>
          <li>ensures MathQuill, Algebrite and math.js load before use</li>
          <li>replaces symbolic work with Algebrite (a JS CAS) instead of math.js symbolic calls that don't exist</li>
          <li>provides helpful error messages and example test cases</li>
        </ul>
      </div>

    </div>
  </div>

  <script>
    // --- dynamic script loader ---
    function loadScript(src){
      return new Promise((resolve,reject)=>{
        const s = document.createElement('script');
        s.src = src;
        s.async = true;
        s.onload = ()=>resolve();
        s.onerror = ()=>reject(new Error('Failed to load '+src));
        document.head.appendChild(s);
      });
    }

    // Helper: remove newlines and trim
    function tidy(s){return (s||'').toString().trim();}

    (async function boot(){
      const outputEl = document.getElementById('output');
      outputEl.textContent = 'Loading libraries...';

      try {
        // Load MathQuill first (CSS already linked in <head>), then Algebrite and math.js
        await loadScript('https://cdn.jsdelivr.net/npm/mathquill@0.10.1/build/mathquill.min.js');
        await loadScript('https://cdnjs.cloudflare.com/ajax/libs/algebrite/1.5.0/algebrite.bundle-for-browser.min.js');
        await loadScript('https://cdnjs.cloudflare.com/ajax/libs/mathjs/11.8.0/math.min.js');
      } catch (err){
        outputEl.innerHTML = '<b style="color:red">Error loading external libraries.</b><div class="small">Check your network or CDN (see console for details).</div>';
        console.error(err);
        return;
      }

      // Validate that MathQuill is available
      if (!window.MathQuill){
        outputEl.innerHTML = '<b style="color:red">MathQuill failed to initialize (MathQuill is not defined).</b>';
        console.error('MathQuill not found on window');
        return;
      }

      // Setup MathQuill field
      const MQ = MathQuill.getInterface(2);
      const mathField = MQ.MathField(document.getElementById('inputField'), {
        spaceBehavesLikeTab: true,
        handlers: { edit: function(){} }
      });

      // Utility: convert a small subset of LaTeX (as emitted by MathQuill) to Algebrite-friendly text
      function latexToAlgebrite(latex){
        if(!latex) return '';
        let out = latex;
        // remove common spacing commands
        out = out.replace(/\\,/g,'').replace(/\\ /g,'').replace(/\\!/g,'');
        // frac -> (a)/(b) (repeat until no frac left)
        while(out.match(/\\frac\{([^}]*)\}\{([^}]*)\}/)){
          out = out.replace(/\\frac\{([^}]*)\}\{([^}]*)\}/g, '((\$1)/(\$2))');
        }
        // common functions and symbols
        out = out.replace(/\\sqrt\{([^}]*)\}/g,'sqrt($1)');
        out = out.replace(/\\left/g,'').replace(/\\right/g,'');
        out = out.replace(/\\cdot/g,'*').replace(/\\times/g,'*');
        out = out.replace(/\\pi/g,'pi');
        out = out.replace(/\\mathrm\{d\}/g,'d');
        // trig/log functions
        out = out.replace(/\\sin/g,'sin').replace(/\\cos/g,'cos').replace(/\\tan/g,'tan');
        out = out.replace(/\\ln/g,'log').replace(/\\log/g,'log');
        // remove remaining backslashes
        out = out.replace(/\\/g,'');
        // convert ^{...}
        out = out.replace(/\^\{([^}]*)\}/g,'^($1)');
        // remove braces used by MathQuill that are not necessary
        out = out.replace(/[\{\}]/g,'');
        // insert * between number and variable, or closing paren and variable/number
        out = out.replace(/(\d)\s*([a-zA-Z\(])/g,'$1*$2');
        out = out.replace(/\)\s*\(/g,')*(');
        // final tidy
        out = out.replace(/\s+/g,'');
        return out;
      }

      // Solve function: returns an object {ok:true, text: '...' }
      function solveFromLatex(latex){
        try{
          // Try match definite integral: \int_{a}^{b} ... \, d x  (with fallbacks)
          const definiteRe1 = /\\int_\{([^}]*)\}\^\{([^}]*)\}([\s\S]*?)\\,?\\mathrm\{d([^}]*)\}/;
          const definiteRe2 = /\\int_\{([^}]*)\}\^\{([^}]*)\}([\s\S]*?)d([a-zA-Z])/;
          const indefRe1 = /\\int([\s\S]*?)\\,?\\mathrm\{d([^}]*)\}/;
          const indefRe2 = /\\int([\s\S]*?)d([a-zA-Z])/;

          let m;
          if(m = latex.match(definiteRe1) || latex.match(definiteRe2)){
            const lowerLatex = m[1];
            const upperLatex = m[2];
            const integrandLatex = m[3];
            const variable = m[4] || m[2] || 'x';

            const integrand = latexToAlgebrite(integrandLatex);
            const lower = latexToAlgebrite(lowerLatex);
            const upper = latexToAlgebrite(upperLatex);

            if(!integrand) return {ok:false, text:'Could not parse integrand.'};

            // symbolic antiderivative using Algebrite
            const F = tidy(Algebrite.run('integral(' + integrand + ',' + variable + ')'));
            if(!F) return {ok:false, text:'Symbolic integration failed.'};

            // try substitution using Algebrite -> valUpper, valLower
            const valU = tidy(Algebrite.run('subst(' + variable + ',(' + upper + '),(' + F + '))'));
            const valL = tidy(Algebrite.run('subst(' + variable + ',(' + lower + '),(' + F + '))'));

            // numeric approximation of difference
            let numeric;
            try{
              numeric = tidy(Algebrite.run('float((' + valU + ')-(' + valL + '))'));
            }catch(e){
              numeric = 'N/A';
            }

            const symDiff = tidy(Algebrite.run('simplify((' + valU + ')-(' + valL + '))'));

            const text = `∫_{${lower}}^{${upper}} ${integrand} d${variable} = ${symDiff} (≈ ${numeric})\nAntiderivative: ${F} + C`;
            return {ok:true, text};

          } else if(m = latex.match(indefRe1) || latex.match(indefRe2)){
            const integrandLatex = m[1];
            const variable = m[2] || 'x';
            const integrand = latexToAlgebrite(integrandLatex);
            if(!integrand) return {ok:false, text:'Could not parse integrand.'};

            const F = tidy(Algebrite.run('integral(' + integrand + ',' + variable + ')'));
            if(!F) return {ok:false, text:'Symbolic integration failed.'};
            return {ok:true, text:`∫ ${integrand} d${variable} = ${F} + C`};
          } else {
            return {ok:false, text:'Please enter an integral. Example: select an example on the right or type "\\int x^2 \\, d x" in the box.'};
          }

        }catch(ex){
          console.error(ex);
          return {ok:false, text:'Internal error while solving: ' + ex.message};
        }
      }

      // Wire buttons
      document.getElementById('solveBtn').addEventListener('click', ()=>{
        const latex = mathField.latex();
        const r = solveFromLatex(latex);
        if(r.ok){
          outputEl.innerHTML = '<pre>' + r.text + '</pre>';
        } else {
          outputEl.innerHTML = '<b style="color:crimson">' + r.text + '</b>';
        }
      });

      document.getElementById('clearBtn').addEventListener('click', ()=>{
        mathField.latex('');
        outputEl.innerHTML = '';
      });

      // Examples: clicking will set LaTeX in the MathQuill field
      document.querySelectorAll('#examples button').forEach(b=>{
        b.addEventListener('click', ()=>{
          const l = b.getAttribute('data-l');
          mathField.latex(l);
          // optional: auto-solve
          //document.getElementById('solveBtn').click();
        });
      });

      // --- Basic internal tests (added as requested) ---
      const tests = [
        {name:'Indefinite: x^2', latex:'\\int x^2 \\, d x', expectContains:'x^3'},
        {name:'Definite: 0->1 x^2', latex:'\\int_{0}^{1} x^2 \\, d x', expectNumeric: (val)=>Math.abs(val-1/3) < 1e-8},
        {name:'Definite: 0->pi sin(x)', latex:'\\int_{0}^{\\pi} \\sin(x) \\, d x', expectNumeric: (val)=>Math.abs(val-2) < 1e-8}
      ];

      function runTests(){
        const results = [];
        for(const t of tests){
          mathField.latex(t.latex);
          const r = solveFromLatex(t.latex);
          if(!r.ok){ results.push({name:t.name, ok:false, msg:r.text}); continue; }
          // try numeric extraction from result text (look for approx value in parentheses)
          const m = r.text.match(/≈\s*([^\)]+)/);
          if(t.expectContains){
            results.push({name:t.name, ok: r.text.indexOf(t.expectContains) !== -1, actual:r.text});
          } else if(t.expectNumeric){
            if(!m){ results.push({name:t.name, ok:false, actual:r.text}); }
            else{
              const num = parseFloat(m[1]);
              results.push({name:t.name, ok: t.expectNumeric(num), numeric:num, actual:r.text});
            }
          } else {
            results.push({name:t.name, ok:true, actual:r.text});
          }
        }
        return results;
      }

      document.getElementById('runTests').addEventListener('click', ()=>{
        const res = runTests();
        const el = document.getElementById('testResults');
        el.innerHTML = '';
        res.forEach(r=>{
          const div = document.createElement('div');
          div.innerHTML = `<strong>${r.name}:</strong> ${r.ok ? '<span class="ok">PASS</span>' : '<span class="bad">FAIL</span>'} <div class="small">${r.actual ? '<pre>'+r.actual+'</pre>' : ''}</div>`;
          el.appendChild(div);
        });
      });

      // initial message
      outputEl.innerHTML = 'Ready — pick an example or type an integral and click Solve.';

    })();
  </script>
</body>
</html>