<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Advanced 2D Graphing Calculator</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/mathquill/0.10.1/mathquill.min.css">
  <style>
    body {
      margin: 0;
      font-family: 'Segoe UI', sans-serif;
      display: flex;
      height: 100vh;
      overflow: hidden;
      background: #f4f4f4;
    }
    #app-container {
      display: flex;
      width: 100%;
      height: 100%;
    }
    #sidebar {
      width: 320px;
      background: #fff;
      border-right: 1px solid #ddd;
      padding: 10px;
      display: flex;
      flex-direction: column;
    }
    #graph-area {
      flex: 1;
      background: #fafafa;
      position: relative;
    }
    canvas {
      width: 100%;
      height: 100%;
      display: block;
    }
    .equation-input-group {
      display: flex;
      align-items: center;
      margin-bottom: 10px;
      background: #f8f8f8;
      border-radius: 8px;
      padding: 5px;
      border: 1px solid #ddd;
    }
    .color-picker {
      width: 24px;
      height: 24px;
      margin-right: 8px;
      border: none;
    }
    .remove-btn {
      margin-left: 5px;
      cursor: pointer;
      color: red;
      border: none;
      background: none;
      font-size: 18px;
      font-weight: bold;
    }
    .add-equation-btn, #keyboard-toggle-btn, #reset-btn {
      margin-top: 10px;
      padding: 10px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      color: #fff;
      background: #3498db;
      transition: background 0.2s;
    }
    .add-equation-btn:hover, #keyboard-toggle-btn:hover, #reset-btn:hover {
      background: #2980b9;
    }
    #keyboard-toggle-btn { background: #2ecc71; }
    #keyboard-toggle-btn:hover { background: #27ae60; }
    #reset-btn { background: #9b59b6; }
    #reset-btn:hover { background: #8e44ad; }
    h2 {
      text-align: center;
      color: #333;
      margin-bottom: 15px;
    }
  </style>
</head>
<body>
  <div id="app-container">
    <div id="sidebar">
      <h2>2D Graphing Calculator</h2>
      <div id="equation-list"></div>
      <button id="add-equation-btn" class="add-equation-btn">+ Add Equation</button>
      <button id="keyboard-toggle-btn">Toggle Keyboard</button>
      <button id="reset-btn">Reset View</button>
    </div>
    <div id="graph-area">
      <canvas id="graph-canvas"></canvas>
    </div>
  </div>

  <!-- MathQuill + Math.js + jQuery -->
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/mathquill/0.10.1/mathquill.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjs/11.11.0/math.min.js"></script>

  <script>
    // ======= GRAPH ENGINE =======
    class Graph2D {
      constructor(canvas) {
        this.canvas = canvas;
        this.ctx = canvas.getContext('2d');
        this.scale = 50;
        this.origin = {x: canvas.width / 2, y: canvas.height / 2};
        this.series = [];
        window.addEventListener('resize', () => this.resize());
        this.resize();
        this.attachEvents();
        requestAnimationFrame(() => this.draw());
      }

      resize() {
        const r = this.canvas.getBoundingClientRect();
        this.canvas.width = r.width * window.devicePixelRatio;
        this.canvas.height = r.height * window.devicePixelRatio;
        this.ctx.setTransform(window.devicePixelRatio, 0, 0, window.devicePixelRatio, 0, 0);
        this.origin.x = r.width / 2;
        this.origin.y = r.height / 2;
        this.draw();
      }

      worldToScreen(x, y) {
        return { sx: this.origin.x + x * this.scale, sy: this.origin.y - y * this.scale };
      }

      screenToWorld(sx, sy) {
        return { x: (sx - this.origin.x) / this.scale, y: (this.origin.y - sy) / this.scale };
      }

      addFunction(fn, color = '#2a62ff') {
        this.series.push({ fn, color });
        this.draw();
      }

      clear() { this.series = []; this.draw(); }

      attachEvents() {
        let drag = false, last = {};
        this.canvas.addEventListener('wheel', (e) => {
          e.preventDefault();
          const factor = e.deltaY > 0 ? 0.9 : 1.1;
          this.scale *= factor;
          this.draw();
        });

        this.canvas.addEventListener('mousedown', (e) => {
          drag = true;
          last = { x: e.clientX, y: e.clientY };
        });

        window.addEventListener('mouseup', () => drag = false);

        window.addEventListener('mousemove', (e) => {
          if (!drag) return;
          const dx = e.clientX - last.x, dy = e.clientY - last.y;
          this.origin.x += dx;
          this.origin.y += dy;
          last = { x: e.clientX, y: e.clientY };
          this.draw();
        });
      }

      resetView() {
        this.scale = 50;
        this.origin = { x: this.canvas.width / 2, y: this.canvas.height / 2 };
        this.draw();
      }

      drawGrid() {
        const ctx = this.ctx;
        const w = this.canvas.width / window.devicePixelRatio;
        const h = this.canvas.height / window.devicePixelRatio;
        ctx.clearRect(0, 0, w, h);
        ctx.strokeStyle = '#ddd';
        ctx.lineWidth = 1;
        const step = this.scale;
        const x0 = this.origin.x % step;
        const y0 = this.origin.y % step;

        for (let x = x0; x < w; x += step) {
          ctx.beginPath();
          ctx.moveTo(x, 0);
          ctx.lineTo(x, h);
          ctx.stroke();
        }

        for (let y = y0; y < h; y += step) {
          ctx.beginPath();
          ctx.moveTo(0, y);
          ctx.lineTo(w, y);
          ctx.stroke();
        }

        ctx.strokeStyle = '#333';
        ctx.lineWidth = 1.5;
        ctx.beginPath();
        ctx.moveTo(0, this.origin.y);
        ctx.lineTo(w, this.origin.y);
        ctx.stroke();
        ctx.beginPath();
        ctx.moveTo(this.origin.x, 0);
        ctx.lineTo(this.origin.x, h);
        ctx.stroke();
      }

      drawFunctions() {
        const ctx = this.ctx;
        const w = this.canvas.width / window.devicePixelRatio;
        for (const s of this.series) {
          ctx.beginPath();
          ctx.strokeStyle = s.color;
          ctx.lineWidth = 2;
          let first = true;
          for (let sx = 0; sx < w; sx += 1) {
            const x = this.screenToWorld(sx, 0).x;
            let y;
            try { y = s.fn(x); }
            catch { continue; }
            const { sy } = this.worldToScreen(0, y);
            if (Number.isFinite(sy)) {
              if (first) { ctx.moveTo(sx, sy); first = false; }
              else { ctx.lineTo(sx, sy); }
            }
          }
          ctx.stroke();
        }
      }

      draw() {
        this.drawGrid();
        this.drawFunctions();
      }
    }

    // ======= UI LOGIC =======
    const MQ = MathQuill.getInterface(2);
    const canvas = document.getElementById('graph-canvas');
    const graph = new Graph2D(canvas);

    function addEquationRow(expr = "") {
      const container = document.createElement('div');
      container.className = 'equation-input-group';
      container.innerHTML = `
        <input type="color" class="color-picker" value="#2a62ff">
        <span class="mathquill-editable"></span>
        <button class="remove-btn">&times;</button>
      `;
      document.getElementById('equation-list').appendChild(container);

      const span = container.querySelector('.mathquill-editable');
      const mq = MQ.MathField(span, { spaceBehavesLikeTab: true });
      mq.latex(expr);
      const colorInput = container.querySelector('.color-picker');
      const removeBtn = container.querySelector('.remove-btn');

      function updateGraph() {
        graph.clear();
        document.querySelectorAll('.equation-input-group').forEach(group => {
          const m = MQ.MathField(group.querySelector('.mathquill-editable'));
          const exprLatex = m.latex();
          const color = group.querySelector('.color-picker').value;
          const parsedExpr = latexToJS(exprLatex);
          try {
            const fn = (x) => math.evaluate(parsedExpr, { x });
            graph.addFunction(fn, color);
          } catch (e) {
            console.warn('Error parsing:', e);
          }
        });
      }

      colorInput.addEventListener('input', updateGraph);
      mq.el().addEventListener('input', () => setTimeout(updateGraph, 300));
      removeBtn.onclick = () => { container.remove(); updateGraph(); };
      updateGraph();
    }

    function latexToJS(latex) {
      return latex
        .replace(/\\left|\\right/g, '')
        .replace(/\\cdot/g, '*')
        .replace(/\\times/g, '*')
        .replace(/\\div/g, '/')
        .replace(/\\frac\{([^}]*)\}\{([^}]*)\}/g, '($1)/($2)')
        .replace(/\\sqrt\{([^}]*)\}/g, 'sqrt($1)')
        .replace(/\\sin/g, 'sin')
        .replace(/\\cos/g, 'cos')
        .replace(/\\tan/g, 'tan')
        .replace(/\\pi/g, 'pi')
        .replace(/\\ln/g, 'log')
        .replace(/\\exp/g, 'exp')
        .replace(/([0-9a-zA-Z)])([a-zA-Z(])/g, '$1*$2');
    }

    document.getElementById('add-equation-btn').onclick = () => addEquationRow();
    document.getElementById('reset-btn').onclick = () => graph.resetView();

    // Initialize with one row
    addEquationRow('x');
  </script>
</body>
</html>
